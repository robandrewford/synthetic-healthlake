version: 2

semantic_models:
  - name: dim_patient_semantic
    model: ref('dim_patient')
    primary_entity: patient
    entities:
      - name: patient
        type: primary
        expr: person_id
    measures:
      - name: patient_count
        agg: count_distinct
        expr: person_id
    dimensions:
      - name: gender
        type: categorical
        expr: fhir_gender
      - name: year_of_birth
        type: time
        expr: year_of_birth
        type_params:
          time_granularity: year

  - name: fact_chronic_condition_semantic
    model: ref('fact_chronic_condition')
    primary_entity: patient_condition
    entities:
      - name: patient_condition
        type: primary
        expr: concat(cast(person_id as varchar), '-', chronic_condition_code)
      - name: patient
        type: foreign
        expr: person_id
        role: primary
    measures:
      - name: chronic_condition_patient_count
        agg: count_distinct
        expr: person_id
      - name: diagnosis_count_total
        agg: sum
        expr: diagnosis_count
    dimensions:
      - name: chronic_condition_code
        type: categorical
        expr: chronic_condition_code

metrics:
  - name: patient_count
    type: simple
    type_params:
      measure: patient_count
    semantic_model: dim_patient_semantic

  - name: chronic_condition_patient_count
    type: simple
    type_params:
      measure: chronic_condition_patient_count
    semantic_model: fact_chronic_condition_semantic

  - name: chronic_condition_prevalence
    type: ratio
    type_params:
      numerator: chronic_condition_patient_count
      denominator: patient_count
