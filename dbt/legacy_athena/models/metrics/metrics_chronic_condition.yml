version: 2

semantic_models:
  - name: dim_patient_semantic
    model: ref('dim_patient')
    defaults:
      agg_time_dimension: year_of_birth
    entities:
      - name: patient
        type: primary
        expr: person_id
    measures:
      - name: patient_count
        agg: count_distinct
        expr: person_id
    dimensions:
      - name: gender
        type: categorical
        expr: fhir_gender
      - name: year_of_birth
        type: time
        expr: year_of_birth
        type_params:
          time_granularity: year

  - name: fact_chronic_condition_semantic
    model: ref('fact_chronic_condition')
    defaults:
      agg_time_dimension: first_diagnosis_date
    entities:
      - name: patient_condition
        type: primary
        expr: concat(cast(person_id as varchar), '-', chronic_condition_code)
      - name: patient
        type: foreign
        expr: person_id
        role: primary
    measures:
      - name: chronic_condition_patient_count
        agg: count_distinct
        expr: person_id
      - name: diagnosis_count_total
        agg: sum
        expr: diagnosis_count
    dimensions:
      - name: chronic_condition_code
        type: categorical
        expr: chronic_condition_code
      - name: first_diagnosis_date
        type: time
        expr: first_diagnosis_date
        type_params:
          time_granularity: day

metrics:
  - name: patient_count
    label: Patient Count
    type: simple
    type_params:
      measure: patient_count

  - name: chronic_condition_patient_count
    label: Chronic Condition Patient Count
    type: simple
    type_params:
      measure: chronic_condition_patient_count

  - name: chronic_condition_prevalence
    label: Chronic Condition Prevalence
    type: ratio
    type_params:
      numerator: chronic_condition_patient_count
      denominator: patient_count
