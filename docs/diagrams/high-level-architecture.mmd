flowchart LR

  subgraph CI["CI/CD & Orchestration"]
    CP[CodePipeline/CodeBuild]
    SF[Step Functions\nPipeline Orchestrator]
  end

  subgraph GEN["Synthetic Data Generation (ECS/EKS)"]
    SYNTHEA[Synthea +\nPython Scripts]
    DOMAIN[Domain Constraints + Terminology + Distributions]
    XVAL[Cross-model Validation]
  end

  subgraph RAW["Raw Storage (S3)"]
    S3_OMOP_RAW[(s3://.../omop_raw)]
    S3_FHIR_RAW[(s3://.../fhir_raw)]
  end

  subgraph ETL["ETL & Flattening"]
    FHIR_PIPES[FHIR Data Pipes]
    OMOP_PARQ[OMOP -> Parquet]
  end

  subgraph CURATED["Curated / Iceberg Tables (S3 + Glue)"]
    GLUE[Glue Catalog]
    ICE_PERSON[[person_iceberg]]
    ICE_PAT[[fhir_patient_flat_iceberg]]
  end

  subgraph TRANSFORM["dbt Marts"]
    DBT[dbt Core]
    DIM_PAT[[dim_patient]]
    FACT_CHRON[[fact_chronic_condition]]
  end

  subgraph QUERY["Analytics & ML"]
    ATH[Athena]
    BI[BI / Dashboards]
    ML[ML Pipelines]
  end

  CP --> SF
  SF --> SYNTHEA
  SYNTHEA --> DOMAIN --> XVAL
  SYNTHEA --> S3_OMOP_RAW
  SYNTHEA --> S3_FHIR_RAW
  XVAL --> S3_OMOP_RAW
  XVAL --> S3_FHIR_RAW

  SF --> FHIR_PIPES
  SF --> OMOP_PARQ
  S3_FHIR_RAW --> FHIR_PIPES --> CURATED
  S3_OMOP_RAW --> OMOP_PARQ --> CURATED

  CURATED --> DBT
  DBT --> DIM_PAT
  DBT --> FACT_CHRON
  DIM_PAT --> ATH
  FACT_CHRON --> ATH
  ATH --> BI
  FACT_CHRON --> ML
